<html>
	<head>
		<title>Tacticle - A daily chess puzzle game</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<link rel="stylesheet" href="assets/styles/styles.css">
		<link rel="stylesheet" href="assets/styles/cm-chessboard.css">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="UTF-8">
	</head>
	<body>
		<header>
			<h1 style="text-align: center; color: rgb(255, 255, 255); margin-bottom: 0px;">Tacticle</h1>
		</header>
		<hr style="border-color: rgb(31, 31, 31); margin-top: 2px; margin-bottom: 10px;">
		<div id="myModal" class="modal">
			<h1 id="modalTitle">Well done!</h1>
			<button id="share">Share</button>
		</div>
		<div id="myBoard" style="height: 85vmin; width: 85vmin"></div>

		<script type="module" id="main">
			import {INPUT_EVENT_TYPE, COLOR, Chessboard, MARKER_TYPE} from "./js/Chessboard.js"
			import { Chess } from "./js/Chess.js"
			import { hardTactics } from "./assets/hardTactics.js"

			const chess = new Chess()
			var pgnIndex = 0
			var attemptNum = 0
			var scoreArray = [0,0,0,0,0,0]
			var finalScore = "X"
			export var tacticOver = false


			const board = new Chessboard(document.getElementById("myBoard"),
				{
				position: chess.fen(),
				style: {cssClass: "blue", moveFromMarker: undefined, moveToMarker: undefined}
				}
			)

				

			setTimeout(() => { 
				alert("Welcome to Tacticle! Ready for the daily puzzle?")
				var today = new Date();
				var Jul13 = new Date("2022/07/13");
				const tacticNo = Math.floor(Math.abs(today-Jul13) / (1000 * 60 * 60 * 24))
				const thisFen = hardTactics[tacticNo][1]
				const correctMoves = hardTactics[tacticNo][2]

				const thisColor = (thisFen.split(' ')[1] === "w") ? COLOR.black : COLOR.white;
				const moveArray = correctMoves.split(' ')

				chess.clear()
				board.setPosition(chess.fen(), false)
				board.setOrientation(thisColor)
				chess.load(thisFen)
				board.setPosition(chess.fen(), false)
				setTimeout(() => {
					opponentMove()
				}, 100)
				board.enableMoveInput(inputHandler, thisColor)

				function opponentMove() {
					board.disableMoveInput()
					if (pgnIndex >= moveArray.length) {
						scoreArray[attemptNum] = -1
						finalScore = attemptNum + 1
						setTimeout(() => {
							openModal("Well done!")
						}, 300)
						return 
					} 
					setTimeout(() => { 
						const oppMove = moveArray[pgnIndex]
						chess.move(oppMove, { sloppy: true})
						board.setPosition(chess.fen(), true)
						pgnIndex += 1
						board.removeMarkers(undefined, MARKER_TYPE.goodSquare)
					}, 500)
					board.enableMoveInput(inputHandler, thisColor)
				}
				function wrongMove() {
					board.disableMoveInput()
					setTimeout(() => { 
						chess.undo()
						board.setPosition(chess.fen(), true)
						board.removeMarkers(undefined, MARKER_TYPE.badSquare)
						incrementAttempt().then(function() {
							if (attemptNum > 5) { 
								board.disableMoveInput()
								openModal("Better luck next time") 
							};
						}, function(err) {
							console.error('count not increment attemptNum: ', err);
						})
					}, 400)
					board.enableMoveInput(inputHandler, thisColor)
				}


				// Initial move
				function inputHandler(event) {
					event.chessboard.removeMarkers(undefined, MARKER_TYPE.dot)
					event.chessboard.removeMarkers(undefined, MARKER_TYPE.square)
					if (event.type === INPUT_EVENT_TYPE.moveStart) {
						const moves = chess.moves({square: event.square, verbose: true});
						event.chessboard.addMarker(event.square, MARKER_TYPE.square)
						for (const move of moves) { // draw dots on possible moves
							event.chessboard.addMarker(move.to, MARKER_TYPE.dot)
						}
						return moves.length > 0
					} else if (event.type === INPUT_EVENT_TYPE.moveDone) {
						const move = event.squareFrom + event.squareTo
						const correctMove = moveArray[pgnIndex]
						var result = chess.move(move, { sloppy: true })
						if (result) {
							if (move != correctMove) {
								event.chessboard.addMarker(event.squareFrom, MARKER_TYPE.badSquare)
								event.chessboard.addMarker(event.squareTo, MARKER_TYPE.badSquare)
								wrongMove()
							} else {
								event.chessboard.addMarker(event.squareFrom, MARKER_TYPE.goodSquare)
								event.chessboard.addMarker(event.squareTo, MARKER_TYPE.goodSquare)
								for (const i in [...Array(6-attemptNum).keys()]) {
									scoreArray[attemptNum+parseInt(i)] += 1
								}
								alert(scoreArray)
								const possibleMoves = chess.moves({verbose: true})
								if (pgnIndex < moveArray.length ) {
									pgnIndex += 1
									opponentMove()
								} 
							}
						} else {
							console.warn("invalid move", move)
						}
						return result
					}
				}

			}, 50)	
			
			const redSquare = String.fromCodePoint(0x1F7E5)
			const greenSquare = String.fromCodePoint(0x1F7E9)
			const blackSquare = String.fromCodePoint(0x2B1B)
			const yellowSquare = String.fromCodePoint(0x1F7E8)

			function copyButton(e) {
				var squareArray = [blackSquare,blackSquare,blackSquare,blackSquare,blackSquare,blackSquare]
				for (const [index,score] of scoreArray.entries()) {
					if (score === 0) {
						squareArray[index] = redSquare
					} else if (score === -1) {
						squareArray[index] = greenSquare;
						break;
					} else {
						squareArray[index] = yellowSquare
					}
				}
				const today = new Date()
				var dateStr = today.getMonth() + "/" + today.getDate() + "/" + today.getFullYear()
				var text = "Tacticle "+ dateStr.substring(0,dateStr.length-4)+ dateStr.substring(dateStr.length-2)  +" "+finalScore+"/6 \n"+squareArray.join() + "\n https://natefoulk4.github.io/tacticle";
				navigator.clipboard.writeText(text).then(function() {
					console.log('Async: Copying to clipboard was successful!');
				}, function(err) {
					console.error('Async: Could not copy text: ', err);
				});
			}
			const modal = document.getElementById("myModal");
			const modalTitle = document.getElementById("modalTitle");

			function openModal(text) {
				modal.style.display = "block"
				modalTitle.innerHTML = text
			}

			function incrementAttempt() { 
				attemptNum += 1; 
				console.log(attemptNum)
				return Promise.resolve("Success");
			}

			const btn = document.querySelector('button');

			btn.addEventListener('click', copyButton);		
	
		</script>
	</body>
</html>
