<html>
	<head>
		<title>Tacticle - A daily chess puzzle game</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<link rel="stylesheet" href="assets/styles/styles.css">
		<link rel="stylesheet" href="assets/styles/cm-chessboard.css">
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<header>
			<h1 style="text-align: center; color: rgb(255, 255, 255); margin-bottom: 0px;">Tacticle</h1>
		</header>
		<hr style="border-color: rgb(31, 31, 31); margin-top: 2px; margin-bottom: 10px;">
		<div id="myBoard" style="height: 85vmin; width: 85vmin"></div>
		<script>
			function copyButton() {
				var text = "Example text to appear on clipboard";
				navigator.clipboard.writeText(text).then(function() {
				console.log('Async: Copying to clipboard was successful!');
				}, function(err) {
				console.error('Async: Could not copy text: ', err);
				});
			}
		</script>
		<button id="share" onclick="copyButton()">Copy something!</button>
		<script type="module">
			import {INPUT_EVENT_TYPE, COLOR, Chessboard, MARKER_TYPE} from "./js/Chessboard.js"
			import { Chess } from "./js/Chess.js"
			import { speedTactics } from "./assets/speedTactics.js"

			const chess = new Chess()
			var pgnIndex = 0
			var tacticOver = false


			const board = new Chessboard(document.getElementById("myBoard"),
				{
				position: chess.fen(),
				style: {cssClass: "blue", moveFromMarker: undefined, moveToMarker: undefined}
				}
			)

				

			setTimeout(() => { 
				alert("Welcome to Tacticle! Ready for the daily puzzle?")
				var today = new Date();
				var Jul13 = new Date("2022/07/13");
				const tacticNo = Math.floor(Math.abs(today-Jul13) / (1000 * 60 * 60 * 24))
				const thisFen = speedTactics[tacticNo][1]
				const correctMoves = speedTactics[tacticNo][2]

				const thisColor = (thisFen.split(' ')[1] === "w") ? COLOR.black : COLOR.white;
				const moveArray = correctMoves.split(' ')

				chess.clear()
				board.setPosition(chess.fen(), false)
				board.setOrientation(thisColor)
				chess.load(thisFen)
				board.setPosition(chess.fen(), false)
				setTimeout(() => {
					opponentMove()
				}, 100)
				board.enableMoveInput(inputHandler, thisColor)

				function opponentMove() {
					board.disableMoveInput()
					if (pgnIndex >= moveArray.length) {
						setTimeout(() => {
							alert("Congratulations!")
						}, 300)
						return 
					}
					setTimeout(() => { 
						const oppMove = moveArray[pgnIndex]
						chess.move(oppMove, { sloppy: true})
						board.setPosition(chess.fen(), true)
						pgnIndex += 1
						board.removeMarkers(undefined, MARKER_TYPE.goodSquare)
					}, 500)
					board.enableMoveInput(inputHandler, thisColor)
				}
				function wrongMove() {
					board.disableMoveInput()
					setTimeout(() => { 
						chess.undo()
						board.setPosition(chess.fen(), true)
						board.removeMarkers(undefined, MARKER_TYPE.badSquare)
					}, 400)
					board.enableMoveInput(inputHandler, thisColor)
				}


				// Initial move
				function inputHandler(event) {
					event.chessboard.removeMarkers(undefined, MARKER_TYPE.dot)
					event.chessboard.removeMarkers(undefined, MARKER_TYPE.square)
					if (event.type === INPUT_EVENT_TYPE.moveStart) {
						const moves = chess.moves({square: event.square, verbose: true});
						event.chessboard.addMarker(event.square, MARKER_TYPE.square)
						for (const move of moves) { // draw dots on possible moves
							event.chessboard.addMarker(move.to, MARKER_TYPE.dot)
						}
						return moves.length > 0
					} else if (event.type === INPUT_EVENT_TYPE.moveDone) {
						const move = event.squareFrom + event.squareTo
						const correctMove = moveArray[pgnIndex]
						var result = chess.move(move, { sloppy: true })
						if (result) {
							if (move != correctMove) {
								event.chessboard.addMarker(event.squareFrom, MARKER_TYPE.badSquare)
								event.chessboard.addMarker(event.squareTo, MARKER_TYPE.badSquare)
								wrongMove()
							} else {
								event.chessboard.addMarker(event.squareFrom, MARKER_TYPE.goodSquare)
								event.chessboard.addMarker(event.squareTo, MARKER_TYPE.goodSquare)
								const possibleMoves = chess.moves({verbose: true})
								if (pgnIndex < moveArray.length ) {
									pgnIndex += 1
									opponentMove()
								} 
							}
						} else {
							console.warn("invalid move", move)
						}
						return result
					}
				}

			}, 50)	
				
	
		</script>
	</body>
</html>
